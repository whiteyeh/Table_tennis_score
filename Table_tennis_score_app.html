<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡Œçƒè¨ˆåˆ†å™¨ï¼ˆé›™/å–®æ‰“æ¨¡å¼ï¼‰</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­ç½®å­—é«”ç‚º Interï¼Œä¸¦ä½¿ç”¨æ·±è‰²æ¨¡å¼ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ç™¼çƒéšŠä¼çš„ç™¼å…‰æ•ˆæœ - æ ¹æ“šéšŠä¼é¡è‰²è¨­å®š */
        .server-glow-team1 {
            /* éšŠä¼ A (ç´…è‰²) ç™¼å…‰ */
            box-shadow: 0 0 20px rgba(248, 113, 113, 0.7); 
            transition: box-shadow 0.3s ease-in-out;
        }
        .server-glow-team2 {
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.7); /* éšŠä¼ B (è—è‰²) ç™¼å…‰ */
            transition: box-shadow 0.3s ease-in-out;
        }
        /* æ¨¡å¼é¸æ“‡å™¨æŒ‰éˆ•æ¨£å¼ */
        .mode-button, .match-format-button {
            transition: all 0.2s;
        }
        .mode-button.active, .match-format-button.active {
            background-color: #10b981; /* Emerald 500 */
            color: #1f2937; /* Gray 800 */
            font-weight: bold;
        }
        /* ç¦ç”¨æŒ‰éˆ•çš„æ¨£å¼ */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* ä¸­å¤®è¨Šæ¯çš„é¡è‰² */
        .general-message {
            color: #4ade80; /* Green 400 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <!-- ä¸»å®¹å™¨ -->
    <div id="app" class="w-full max-w-3xl bg-gray-800 p-8 rounded-xl shadow-2xl space-y-8">
        <h1 id="main-title" class="text-4xl font-bold text-center text-green-400">æ¡Œçƒæ¯”åˆ†æ¿</h1>

        <!-- æ¨¡å¼é¸æ“‡å™¨ (å–®æ‰“/é›™æ‰“) -->
        <div class="flex justify-center space-x-2 bg-gray-700 p-2 rounded-lg">
            <button id="mode-singles" onclick="setGameMode('SINGLES')" class="mode-button flex-1 py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">
                å–®æ‰“
            </button>
            <button id="mode-doubles" onclick="setGameMode('DOUBLES')" class="mode-button flex-1 py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">
                é›™æ‰“
            </button>
        </div>
        
        <!-- ç¸½å±€æ•¸é¸æ“‡å™¨ -->
        <div class="text-center mt-4">
            <p class="text-md font-medium text-gray-400 mb-2">é¸æ“‡æ¯”è³½å±€åˆ¶</p>
            <div class="flex justify-center space-x-2 bg-gray-700 p-2 rounded-lg">
                <button id="format-3" onclick="setMatchFormat(3)" class="match-format-button flex-1 py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">
                    ä¸‰å±€å…©å‹
                </button>
                <button id="format-5" onclick="setMatchFormat(5)" class="match-format-button flex-1 py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">
                    äº”å±€ä¸‰å‹
                </button>
            </div>
        </div>

        <!-- å±€æ•¸çµ±è¨ˆå’Œæ­·å²æ¯”åˆ† -->
        <div class="text-center mb-6">
            <p id="set-format-text" class="text-lg font-semibold text-gray-400">ç¸½å±€æ•¸ (ä¸‰å±€å…©å‹)</p>
            <div id="set-scores" class="text-5xl font-extrabold text-white space-x-4">
                <span id="set-score-1" class="text-red-400">0</span>
                <span class="text-gray-500">-</span>
                <span id="set-score-2" class="text-blue-300">0</span>
            </div>
            
            <!-- å–®å±€æ¯”åˆ†æ­·å²é¡¯ç¤ºå€ -->
            <div id="set-history-container" class="mt-4 text-sm bg-gray-700/50 p-3 rounded-lg mx-auto max-w-md">
                <p class="font-semibold mb-2 text-gray-300 border-b border-gray-600 pb-1">å–®å±€æ¯”åˆ†æ­·å² (ç´…/è—)</p>
                <!-- å¯¦éš›æ¯”åˆ†è¨˜éŒ„æœƒæ³¨å…¥åˆ°é€™è£¡ -->
                <div id="set-history" class="flex justify-center flex-wrap gap-x-3 gap-y-1 min-h-[1.5rem]">
                    <span id="history-placeholder" class="text-gray-500">å°šç„¡å·²å®Œæˆå±€æ•¸</span>
                </div>
            </div>
        </div>

        <!-- æ¯”åˆ†é¡¯ç¤ºå€ -->
        <div class="flex justify-around text-center space-x-4">
            
            <!-- A éšŠ/ç©å®¶å¡ç‰‡ -->
            <div id="team1-card" class="player-card flex-1 p-6 rounded-lg bg-gray-700 transition duration-300">
                <h2 id="team1-name" class="text-2xl font-bold mb-2 text-red-400">ç©å®¶ A</h2>
                <p id="team1-players" class="text-sm text-gray-400 mb-4 h-5">A1</p>
                <p id="score-1" class="text-8xl font-extrabold text-white">0</p>
                <button onclick="addPoint(0)" class="mt-6 w-full py-3 bg-red-600 hover:bg-red-700 transition duration-200 rounded-lg font-bold text-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-red-500/50">
                    ç©å®¶ A å¾— 1 åˆ†
                </button>
            </div>

            <!-- B éšŠ/ç©å®¶å¡ç‰‡ -->
            <div id="team2-card" class="player-card flex-1 p-6 rounded-lg bg-gray-700 transition duration-300">
                <h2 id="team2-name" class="text-2xl font-bold mb-2 text-blue-300">ç©å®¶ B</h2>
                <p id="team2-players" class="text-sm text-gray-400 mb-4 h-5">B1</p>
                <p id="score-2" class="text-8xl font-extrabold text-white">0</p>
                <button onclick="addPoint(1)" class="mt-6 w-full py-3 bg-blue-600 hover:bg-blue-700 transition duration-200 rounded-lg font-bold text-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-500/50">
                    ç©å®¶ B å¾— 1 åˆ†
                </button>
            </div>
        </div>

        <!-- ç™¼çƒ/æ¥ç™¼çƒç‹€æ…‹å€ (å·¦å³åˆ†æ¬„é¡¯ç¤º + ä¸­å¤®ç®­é ­) -->
        <div class="flex justify-between items-center text-center space-x-4 pt-2">
            <!-- A éšŠç‹€æ…‹ (å·¦) -->
            <p id="server-status-a" class="flex-1 text-lg font-semibold text-red-400 min-h-[1.5rem]"></p>
            <!-- ç®­é ­å€ -->
            <!-- èª¿æ•´: æ”¾å¤§åˆ° text-4xlï¼Œé¡è‰²æ”¹ç‚º text-white è®“ç®­é ­æ›´çªå‡º -->
            <div id="server-direction" class="w-10 text-4xl font-extrabold text-white"></div>
            <!-- B éšŠç‹€æ…‹ (å³) -->
            <p id="server-status-b" class="flex-1 text-lg font-semibold text-blue-300 min-h-[1.5rem]"></p>
        </div>
        
        <!-- éŠæˆ²è¨Šæ¯èˆ‡æ§åˆ¶å€ -->
        <div class="space-y-4 pt-1">
            <!-- ç¸½é«”éŠæˆ²ç‹€æ…‹è¨Šæ¯ (å¦‚ Deuce, Game Over) -->
            <p id="game-message" class="text-center text-xl font-bold general-message min-h-[1.5rem]"></p>
            
            <div class="flex justify-center space-x-4">
                <!-- å›ä¸Šä¸€æ­¥æŒ‰éˆ• -->
                <button onclick="undoPoint()" id="undo-button" disabled class="py-2 px-6 bg-purple-600 hover:bg-purple-700 transition duration-200 rounded-lg font-medium shadow-md focus:outline-none focus:ring-4 focus:ring-purple-500/50">
                    âª å›ä¸Šä¸€æ­¥
                </button>
                <button onclick="changeServerManually()" class="py-2 px-6 bg-yellow-600 hover:bg-yellow-700 transition duration-200 rounded-lg font-medium shadow-md focus:outline-none focus:ring-4 focus:ring-yellow-500/50">
                    æ‰‹å‹•åˆ‡æ›ç™¼çƒè€…
                </button>
                <button onclick="resetGame()" class="py-2 px-6 bg-gray-600 hover:bg-gray-500 transition duration-200 rounded-lg font-medium shadow-md focus:outline-none focus:ring-4 focus:ring-gray-500/50">
                    é‡ç½®æ–°å±€
                </button>
            </div>
        </div>
        
    </div>

    <!-- JavaScript éŠæˆ²é‚è¼¯ -->
    <script>
        // æ¨¡å¼å¸¸æ•¸
        const MODE_SINGLES = 'SINGLES';
        const MODE_DOUBLES = 'DOUBLES';

        // éŠæˆ²ç‹€æ…‹è®Šæ•¸
        let scores = [0, 0]; // [A éšŠ, B éšŠ]
        let serverIndex = 0; // ç•¶å‰ç™¼çƒè€…åœ¨ currentServerSequence ä¸­çš„ç´¢å¼•
        let gameOver = false; // ç•¶å‰å±€æ˜¯å¦çµæŸ
        let gameMode = MODE_SINGLES; // é è¨­ç‚ºå–®æ‰“ 
        
        // ç¸½å±€æ•¸å’Œæ¯”è³½ç‹€æ…‹
        let setScores = [0, 0]; // [A éšŠå±€æ•¸, B éšŠå±€æ•¸]
        let matchOver = false; // æ•´å€‹æ¯”è³½æ˜¯å¦çµæŸ
        let BEST_OF_SETS = 3; // é è¨­ä¸‰å±€ 
        let SETS_TO_WIN = 2;  // é è¨­å…©å‹ 

        // å–®å±€æ¯”åˆ†æ­·å²
        let finishedSetScores = []; // å„²å­˜å·²å®Œæˆçš„æ¯ä¸€å±€æ¯”åˆ†ï¼Œä¾‹å¦‚ [[11, 8], [9, 11]]

        // è¨ˆåˆ†æ­·å²è¨˜éŒ„
        let history = []; 

        // æ¨¡å¼ç‰¹å®šçš„é…ç½®
        let currentServerSequence = [];
        
        // æ‰€æœ‰çš„ç™¼çƒåºåˆ—é…ç½®
        const CONFIG = {
            [MODE_SINGLES]: {
                title: 'æ¡Œçƒå–®æ‰“æ¯”åˆ†æ¿',
                team1Name: 'ç©å®¶ A',
                team2Name: 'ç©å®¶ B',
                team1Players: 'A1', // 2. å°‡P1æ”¹ç‚ºA1
                team2Players: 'B1', // 3. å°‡P3æ”¹ç‚ºB1
                sequence: [
                    { player: 0, team: 0, name: 'A1 (ç©å®¶ A)' }, // 2. å°‡P1æ”¹ç‚ºA1
                    { player: 1, team: 1, name: 'B1 (ç©å®¶ B)' }  // 3. å°‡P3æ”¹ç‚ºB1
                ],
                sequenceLength: 2 
            },
            [MODE_DOUBLES]: {
                title: 'æ¡Œçƒé›™æ‰“æ¯”åˆ†æ¿',
                team1Name: 'A éšŠ',
                team2Name: 'B éšŠ',
                team1Players: 'A1 / A2', // 2. å°‡P1/P2æ”¹ç‚ºA1/A2
                team2Players: 'B1 / B2', // 3. å°‡P3/P4æ”¹ç‚ºB1/B2
                sequence: [
                    { player: 0, team: 0, name: 'A1 (A éšŠ)' }, // 2. å°‡P1æ”¹ç‚ºA1
                    { player: 2, team: 1, name: 'B1 (B éšŠ)' }, // 3. å°‡P3æ”¹ç‚ºB1
                    { player: 1, team: 0, name: 'A2 (A éšŠ)' }, // 2. å°‡P2æ”¹ç‚ºA2
                    { player: 3, team: 1, name: 'B2 (B éšŠ)' }  // 3. å°‡P4æ”¹ç‚ºB2
                ],
                sequenceLength: 4 
            }
        };


        // DOM å…ƒç´ åƒè€ƒ
        const scoreDisplays = [
            document.getElementById('score-1'),
            document.getElementById('score-2')
        ];
        const setScoreDisplays = [ 
            document.getElementById('set-score-1'),
            document.getElementById('set-score-2')
        ];
        const teamCards = [
            document.getElementById('team1-card'),
            document.getElementById('team2-card')
        ];
        const teamNamesDisplay = [
            document.getElementById('team1-name'),
            document.getElementById('team2-name')
        ];
        const teamPlayersDisplay = [
            document.getElementById('team1-players'),
            document.getElementById('team2-players')
        ];
        const pointButtons = document.querySelectorAll('button[onclick^="addPoint"]');
        const undoButton = document.getElementById('undo-button'); 
        const gameMessage = document.getElementById('game-message');
        const mainTitle = document.getElementById('main-title');
        const setFormatText = document.getElementById('set-format-text'); 
        const modeButtons = {
            [MODE_SINGLES]: document.getElementById('mode-singles'),
            [MODE_DOUBLES]: document.getElementById('mode-doubles')
        };
        const matchFormatButtons = { 
            3: document.getElementById('format-3'),
            5: document.getElementById('format-5')
        };
        const setHistoryDisplay = document.getElementById('set-history');
        const historyPlaceholder = document.getElementById('history-placeholder');
        // æ–°å¢çš„ç‹€æ…‹é¡¯ç¤ºå…ƒç´ 
        const serverStatusA = document.getElementById('server-status-a');
        const serverStatusB = document.getElementById('server-status-b');
        const serverDirection = document.getElementById('server-direction'); // <--- æ–°å¢çš„ç®­é ­å…ƒç´ 
        
        /**
         * å–å¾—ç•¶å‰æ¥ç™¼çƒè€…çš„åç¨±
         * åœ¨ç™¼çƒåºåˆ—ä¸­æ‰¾åˆ°ç·Šè·Ÿåœ¨ç™¼çƒéšŠä¼ä¹‹å¾Œçš„ç¬¬ä¸€å€‹æ¥ç™¼çƒéšŠä¼çš„ç©å®¶ã€‚
         * @returns {string} æ¥ç™¼çƒè€…çš„å®Œæ•´åç¨± (ä¾‹å¦‚ 'B1 (ç©å®¶ B)')
         */
        function getReceiverInfo() {
            if (currentServerSequence.length === 0) return 'å°æ‰‹';

            const serverInfo = currentServerSequence[serverIndex];
            const servingTeam = serverInfo.team;
            const receivingTeam = (servingTeam + 1) % 2; // 0 -> 1, 1 -> 0
            
            let receiverPlayer = '';

            // å¾ä¼ºæœå™¨ç´¢å¼•çš„ä¸‹ä¸€ä½é–‹å§‹ï¼Œå¾ªç’°æª¢æŸ¥åºåˆ—ï¼Œç›´åˆ°æ‰¾åˆ°å±¬æ–¼æ¥ç™¼çƒéšŠä¼çš„ç©å®¶
            let checkIndex = serverIndex;
            let foundReceiver = false;
            
            for (let i = 1; i <= currentServerSequence.length; i++) {
                checkIndex = (serverIndex + i) % currentServerSequence.length;
                const potentialReceiver = currentServerSequence[checkIndex];
                
                // æ‰¾åˆ°ç¬¬ä¸€å€‹å±¬æ–¼æ¥ç™¼çƒéšŠä¼çš„ç©å®¶
                if (potentialReceiver.team === receivingTeam) {
                    receiverPlayer = potentialReceiver.name;
                    foundReceiver = true;
                    break; 
                }
            }
            
            if (!foundReceiver) {
                // å¦‚æœæ²’æœ‰æ‰¾åˆ°ï¼Œè¿”å›éšŠä¼åç¨± (ä½œç‚ºå‚™ç”¨)
                receiverPlayer = receivingTeam === 0 ? CONFIG[gameMode].team1Name : CONFIG[gameMode].team2Name;
            }

            return receiverPlayer;
        }

        /**
         * æ¸²æŸ“ç™¼çƒèˆ‡æ¥ç™¼çƒç‹€æ…‹è¨Šæ¯åˆ°å·¦å³å…©å´
         */
        function renderServerStatus() {
            if (matchOver || gameOver) {
                serverStatusA.textContent = '';
                serverStatusB.textContent = '';
                serverDirection.textContent = ''; // æ¸…é™¤ç®­é ­
                return;
            }

            const serverInfo = currentServerSequence[serverIndex];
            const serverName = serverInfo.name.split(' ')[0]; // åªéœ€è¦ç©å®¶ä»£è™Ÿ (A1, B1...)
            const servingTeam = serverInfo.team;
            const receiverName = getReceiverInfo().split(' ')[0]; 

            // æ¸…é™¤ç¾æœ‰çš„æ¨£å¼
            // Reset to base classes
            serverStatusA.className = 'flex-1 text-lg font-semibold min-h-[1.5rem]';
            serverStatusB.className = 'flex-1 text-lg font-semibold min-h-[1.5rem]';

            // Define team colors and emphasis class for server
            const teamAColor = 'text-red-400';
            const teamBColor = 'text-blue-300';
            const serverEmphasis = 'font-bold'; // Use bold for the server's status

            if (servingTeam === 0) {
                // Team A (Left) is serving
                serverStatusA.textContent = `ğŸ¯ ${serverName} ç™¼çƒ`;
                serverStatusB.textContent = `â†©ï¸ ${receiverName} æ¥çƒ`; 
                
                // è¨­å®šç®­é ­ï¼šå‘å³ (å¾ A åˆ° B)
                serverDirection.textContent = 'â†’'; 

                // Server (Team A - Left): Red + Bold
                serverStatusA.classList.add(teamAColor, serverEmphasis);
                // Receiver (Team B - Right): Blue (Matching team color)
                serverStatusB.classList.add(teamBColor); 

            } else {
                // Team B (Right) is serving
                serverStatusA.textContent = `â†©ï¸ ${receiverName} æ¥çƒ`; 
                serverStatusB.textContent = `ğŸ¯ ${serverName} ç™¼çƒ`;
                
                // è¨­å®šç®­é ­ï¼šå‘å·¦ (å¾ B åˆ° A)
                serverDirection.textContent = 'â†';

                // Receiver (Team A - Left): Red (Matching team color)
                serverStatusA.classList.add(teamAColor); 
                // Server (Team B - Right): Blue + Bold
                serverStatusB.classList.add(teamBColor, serverEmphasis); 
            }
        }


        /**
         * æ ¹æ“šç›®å‰å®Œæˆçš„å±€æ•¸ï¼Œæ¸²æŸ“å–®å±€æ¯”åˆ†æ­·å²
         */
        function renderSetHistory() {
            setHistoryDisplay.innerHTML = ''; // æ¸…é™¤èˆŠçš„æ­·å²è¨˜éŒ„

            if (finishedSetScores.length === 0) {
                setHistoryDisplay.innerHTML = '<span class="text-gray-500" id="history-placeholder">å°šç„¡å·²å®Œæˆå±€æ•¸</span>';
                return;
            }
            
            finishedSetScores.forEach((setScore, index) => {
                const setDiv = document.createElement('div');
                setDiv.className = 'py-0.5 px-2 rounded text-xs font-mono bg-gray-600 shadow-sm';
                
                // æ ¹æ“šæ¯”åˆ†æ±ºå®šå‹è€…çš„é¡è‰²
                let teamAClass = setScore[0] > setScore[1] ? 'text-red-400 font-bold' : 'text-white';
                let teamBClass = setScore[1] > setScore[0] ? 'text-blue-300 font-bold' : 'text-white';

                setDiv.innerHTML = `
                    <span class="text-gray-400 mr-1">å±€${index + 1}:</span>
                    <span class="${teamAClass}">${setScore[0]}</span>
                    <span class="text-gray-500">-</span>
                    <span class="${teamBClass}">${setScore[1]}</span>
                `;
                setHistoryDisplay.appendChild(setDiv);
            });
        }


        /**
         * è¨­å®šç¸½å±€æ•¸æ ¼å¼ (ä¸‰å±€å…©å‹æˆ–äº”å±€å…©å‹)
         * @param {number} sets - 3 æˆ– 5
         */
        function setMatchFormat(sets) {
            if (sets !== 3 && sets !== 5) return;

            BEST_OF_SETS = sets;
            SETS_TO_WIN = Math.ceil(BEST_OF_SETS / 2);

            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            matchFormatButtons[3].classList.remove('active', 'bg-emerald-500', 'text-gray-800');
            matchFormatButtons[5].classList.remove('active', 'bg-emerald-500', 'text-gray-800');
            matchFormatButtons[sets].classList.add('active', 'bg-emerald-500', 'text-gray-800');
            
            // æ›´æ–°å±€æ•¸æ–‡å­—æè¿°
            const formatText = sets === 3 ? 'ä¸‰å±€å…©å‹' : 'äº”å±€ä¸‰å‹';
            setFormatText.textContent = `ç¸½å±€æ•¸ (${formatText})`;

            // æ¸…ç©ºå–®å±€æ¯”åˆ†æ­·å²
            finishedSetScores = [];

            // å®Œå…¨é‡ç½®æ¯”è³½
            setScores = [0, 0];
            matchOver = false;
            resetGame(false); // é‡ç½®éŠæˆ²ä¸¦æ›´æ–° UI
        }

        /**
         * æ ¹æ“šé¸æ“‡çš„æ¨¡å¼è¨­å®šéŠæˆ²é…ç½®ä¸¦é‡ç½®
         * @param {string} mode - 'SINGLES' æˆ– 'DOUBLES'
         */
        function setGameMode(mode) {
            gameMode = mode;
            const config = CONFIG[gameMode];

            // æ›´æ–°æ¨¡å¼æŒ‰éˆ•æ¨£å¼
            modeButtons[MODE_SINGLES].classList.remove('active', 'bg-emerald-500', 'text-gray-800');
            modeButtons[MODE_DOUBLES].classList.remove('active', 'bg-emerald-500', 'text-gray-800');
            modeButtons[gameMode].classList.add('active', 'bg-emerald-500', 'text-gray-800');

            // è¨­ç½®æ–‡å­—
            mainTitle.textContent = config.title;
            teamNamesDisplay[0].textContent = config.team1Name;
            teamNamesDisplay[1].textContent = config.team2Name;
            teamPlayersDisplay[0].textContent = config.team1Players;
            teamPlayersDisplay[1].textContent = config.team2Players;
            pointButtons[0].textContent = `${config.team1Name} å¾— 1 åˆ†`;
            pointButtons[1].textContent = `${config.team2Name} å¾— 1 åˆ†`;

            currentServerSequence = config.sequence;
            
            // å®Œå…¨é‡ç½®æ¯”è³½ï¼Œä¿ç•™ç•¶å‰çš„ BEST_OF_SETS è¨­å®š
            setScores = [0, 0];
            matchOver = false;
            finishedSetScores = []; // åˆ‡æ›æ¨¡å¼æ™‚ä¹Ÿæ‡‰æ¸…ç©ºæ¯”åˆ†æ­·å²

            resetGame(false); 

            // ç¢ºä¿ç¸½å±€æ•¸æ ¼å¼çš„æ¨™ç±¤å’ŒæŒ‰éˆ•ç‹€æ…‹æ˜¯æœ€æ–°çš„ (BEST_OF_SETS åœ¨æ­¤è™•ä¸è®Š)
            const formatText = BEST_OF_SETS === 3 ? 'ä¸‰å±€å…©å‹' : 'äº”å±€ä¸‰å‹';
            setFormatText.textContent = `ç¸½å±€æ•¸ (${formatText})`;
            matchFormatButtons[3].classList.remove('active', 'bg-emerald-500', 'text-gray-800');
            matchFormatButtons[5].classList.remove('active', 'bg-emerald-500', 'text-gray-800');
            matchFormatButtons[BEST_OF_SETS].classList.add('active', 'bg-emerald-500', 'text-gray-800');
        }


        /**
         * æª¢æŸ¥æ˜¯å¦é”åˆ°å±€é»æˆ–å‹åˆ©æ¢ä»¶
         * @returns {boolean} å¦‚æœæ¯”è³½æˆ–æœ¬å±€çµæŸï¼Œè¿”å› true
         */
        function checkWinCondition() {
            const p1 = scores[0];
            const p2 = scores[1];
            
            // 1. å¦‚æœæ¯”è³½å·²ç¶“çµæŸï¼Œåªé¡¯ç¤ºæ¯”è³½å‹åˆ©è¨Šæ¯
            if (matchOver) {
                const matchWinner = setScores[0] > setScores[1] ? CONFIG[gameMode].team1Name : CONFIG[gameMode].team2Name;
                gameMessage.textContent = `ğŸ‰ æ¯”è³½çµæŸï¼${matchWinner} ä»¥ ${setScores[0]} - ${setScores[1]} ç²å‹ï¼`;
                pointButtons.forEach(btn => btn.disabled = true);
                return true;
            }
            
            // 2. å¦‚æœæœ¬å±€å·²ç¶“çµæŸï¼Œåªé¡¯ç¤ºå±€æ•¸å‹åˆ©è¨Šæ¯
            if (gameOver) {
                const winnerIndex = p1 > p2 ? 0 : 1;
                const winner = winnerIndex === 0 ? CONFIG[gameMode].team1Name : CONFIG[gameMode].team2Name;
                gameMessage.textContent = `âœ… å±€æ•¸çµæŸï¼ ${winner} æ‹¿ä¸‹æ­¤å±€ï¼è«‹é»æ“Š "é‡ç½®æ–°å±€" é–‹å§‹ä¸‹ä¸€å±€ã€‚`;
                pointButtons.forEach(btn => btn.disabled = true);
                return true;
            }

            // 3. æ­£å¸¸è¨ˆåˆ†é‚è¼¯
            let message = 'æ¯”è³½é€²è¡Œä¸­...'; // 1. å°‡'éŠæˆ²é€²è¡Œä¸­...'æ”¹ç‚º'æ¯”è³½é€²è¡Œä¸­...'
            
            if (p1 >= 11 || p2 >= 11) {
                const diff = Math.abs(p1 - p2);
                
                if (diff >= 2) {
                    // **å±€æ•¸ç²å‹æ¢ä»¶**
                    gameOver = true;
                    const winnerIndex = p1 > p2 ? 0 : 1;
                    
                    // ç´€éŒ„æœ¬å±€æ¯”åˆ†
                    finishedSetScores.push([...scores]); 
                    
                    // æ›´æ–°ç¸½å±€æ•¸
                    setScores[winnerIndex]++; 

                    // æª¢æŸ¥æ˜¯å¦æ¯”è³½ç²å‹
                    if (setScores[winnerIndex] >= SETS_TO_WIN) {
                        matchOver = true;
                        const matchWinner = winnerIndex === 0 ? CONFIG[gameMode].team1Name : CONFIG[gameMode].team2Name;
                        message = `ğŸ‰ æ¯”è³½çµæŸï¼${matchWinner} ä»¥ ${setScores[0]} - ${setScores[1]} ç²å‹ï¼`;
                    } else {
                        const winner = winnerIndex === 0 ? CONFIG[gameMode].team1Name : CONFIG[gameMode].team2Name;
                        message = `âœ… å±€æ•¸çµæŸï¼ ${winner} æ‹¿ä¸‹æ­¤å±€ï¼è«‹é»æ“Š "é‡ç½®æ–°å±€" é–‹å§‹ä¸‹ä¸€å±€ã€‚`;
                    }
                    
                    // ç¦ç”¨è¨ˆåˆ†æŒ‰éˆ•ç›´åˆ°é‡ç½®
                    pointButtons.forEach(btn => btn.disabled = true);

                } else if (p1 >= 10 && p2 >= 10) {
                    // å¹³æ‰‹ (Deuce) ç‹€æ…‹
                    message = `ğŸš¨ å¹³æ‰‹ (Deuce)ï¼`;
                }
            }
            
            gameMessage.textContent = message;
            return matchOver || gameOver;
        }

        /**
         * æ ¹æ“šç›®å‰æ¯”åˆ†æ±ºå®šæ˜¯å¦åˆ‡æ›ç™¼çƒè€…
         */
        function checkServerChange() {
            const totalPoints = scores[0] + scores[1];
            
            // æª¢æŸ¥æ˜¯å¦ç‚º Deuce ç‹€æ…‹ (10-10 æˆ–ä¹‹å¾Œ)
            const isDeuce = scores[0] >= 10 && scores[1] >= 10;
            
            // æ±ºå®šæ›ç™¼çƒçš„é–“éš”
            const interval = isDeuce ? 1 : 2; 

            if (totalPoints > 0 && totalPoints % interval === 0) {
                serverIndex = (serverIndex + 1) % currentServerSequence.length;
            }
        }

        /**
         * æ›´æ–°ç¶²é ä¸Šçš„é¡¯ç¤º
         */
        function render() {
            scoreDisplays[0].textContent = scores[0];
            scoreDisplays[1].textContent = scores[1];
            
            // æ›´æ–°å±€æ•¸é¡¯ç¤º
            setScoreDisplays[0].textContent = setScores[0];
            setScoreDisplays[1].textContent = setScores[1];

            // å–å¾—ç›®å‰ç™¼çƒè€…çš„éšŠä¼ (0 æˆ– 1)
            const currentServingTeam = currentServerSequence.length > 0 
                ? currentServerSequence[serverIndex].team 
                : 0; // é è¨­ç‚ºéšŠä¼ A/0

            // æ›´æ–°å¡ç‰‡ç™¼å…‰æ•ˆæœ (æŒ‡ç¤ºç™¼çƒéšŠä¼)
            teamCards[0].classList.remove('server-glow-team1', 'server-glow-team2');
            teamCards[1].classList.remove('server-glow-team1', 'server-glow-team2');

            if (currentServingTeam === 0) {
                teamCards[0].classList.add('server-glow-team1');
            } else if (currentServingTeam === 1) {
                teamCards[1].classList.add('server-glow-team2');
            }

            // checkWinCondition æœƒæ›´æ–° gameMessage
            checkWinCondition(); 
            
            // ç¨ç«‹æ¸²æŸ“ç™¼çƒ/æ¥ç™¼çƒç‹€æ…‹
            renderServerStatus();

            // æ›´æ–°å›ä¸Šä¸€æ­¥æŒ‰éˆ•çš„ç¦ç”¨ç‹€æ…‹
            undoButton.disabled = history.length === 0;

            renderSetHistory(); // æ¸²æŸ“å–®å±€æ¯”åˆ†æ­·å²
        }

        /**
         * ç‚ºæŒ‡å®šéšŠä¼å¢åŠ  1 åˆ†
         * @param {number} team - 0 for Team A/Player A, 1 for Team B/Player B
         */
        function addPoint(team) {
            if (matchOver || gameOver) return; // æ¯”è³½æˆ–æœ¬å±€çµæŸå¾Œç„¡æ³•è¨ˆåˆ†
            
            // 1. å„²å­˜ç•¶å‰çš„å®Œæ•´éŠæˆ²ç‹€æ…‹åˆ°æ­·å²è¨˜éŒ„ä¸­
            history.push({ 
                scores: [...scores], 
                serverIndex: serverIndex, 
                gameOver: gameOver,
                setScores: [...setScores], 
                matchOver: matchOver,
                finishedSetScores: JSON.parse(JSON.stringify(finishedSetScores)) // æ·±æ‹·è²
            });

            // 2. æ›´æ–°åˆ†æ•¸å’Œæª¢æŸ¥ç™¼çƒæ¬Š
            scores[team]++;
            checkServerChange();
            render();
        }

        /**
         * å›ä¸Šä¸€æ­¥
         */
        function undoPoint() {
            if (history.length === 0) return;

            // 1. å¾æ­·å²è¨˜éŒ„ä¸­å–å‡ºå‰ä¸€å€‹ç‹€æ…‹
            const prevState = history.pop();
            
            // 2. æ¢å¾©éŠæˆ²ç‹€æ…‹
            scores = prevState.scores;
            serverIndex = prevState.serverIndex;
            gameOver = prevState.gameOver;
            setScores = prevState.setScores;
            matchOver = prevState.matchOver;
            finishedSetScores = prevState.finishedSetScores; // æ¢å¾©æ­·å²æ¯”åˆ†

            // 3. æ ¹æ“šç‹€æ…‹é‡æ–°å•Ÿç”¨/ç¦ç”¨æŒ‰éˆ•
            pointButtons.forEach(btn => btn.disabled = matchOver || gameOver);

            gameMessage.textContent = 'âª å·²é‚„åŸä¸Šä¸€æ­¥ã€‚';
            render();
        }
        
        /**
         * æ‰‹å‹•åˆ‡æ›ç™¼çƒè€…
         */
        function changeServerManually() {
            if (matchOver || gameOver) return; // æ¯”è³½æˆ–æœ¬å±€çµæŸå¾Œä¸èƒ½æ‰‹å‹•åˆ‡æ›ç™¼çƒè€…

            // æ‰‹å‹•åˆ‡æ›ä¹Ÿæ‡‰ç•¶è¨˜éŒ„åˆ°æ­·å²ä¸­ï¼Œä»¥ä¾¿å¯ä»¥é‚„åŸ
            history.push({ 
                scores: [...scores], 
                serverIndex: serverIndex, 
                gameOver: gameOver,
                setScores: [...setScores], 
                matchOver: matchOver,
                finishedSetScores: JSON.parse(JSON.stringify(finishedSetScores))
            });

            serverIndex = (serverIndex + 1) % currentServerSequence.length;
            gameMessage.textContent = `æ‰‹å‹•åˆ‡æ›ç™¼çƒè€…å®Œæˆã€‚`;
            render();
        }

        /**
         * é‡ç½®æ‰€æœ‰ç‹€æ…‹ä¸¦é–‹å§‹æ–°çš„ä¸€å±€æˆ–æ–°çš„ä¸€å ´æ¯”è³½
         * @param {boolean} [showMessage=true] - æ˜¯å¦é¡¯ç¤ºæ­¡è¿è¨Šæ¯
         */
        function resetGame(showMessage = true) {
            
            // ã€ä¿®æ­£ã€‘ç¢ºä¿ serverIndex åœ¨ä½¿ç”¨å‰è¢«é‡è¨­ç‚º 0ï¼Œé¿å…åˆ‡æ›æ¨¡å¼æ™‚ç´¢å¼•è¶…å‡ºé‚Šç•Œã€‚
            serverIndex = 0; 

            const formatText = BEST_OF_SETS === 3 ? 'ä¸‰å±€å…©å‹' : 'äº”å±€ä¸‰å‹';
            const serverName = currentServerSequence.length > 0 ? currentServerSequence[serverIndex].name : 'ç™¼çƒè€…';
            
            if (matchOver) {
                // æ¯”è³½çµæŸï¼Œé€²è¡Œå®Œå…¨é‡ç½® (æ–°æ¯”è³½)
                setScores = [0, 0];
                matchOver = false;
                finishedSetScores = []; // æ¸…é™¤å–®å±€æ­·å²
                if (showMessage) gameMessage.textContent = `ğŸ† å…¨å±€æ¯”åˆ†å·²é‡ç½® (${formatText})ã€‚é–‹å§‹æ–°ä¸€å ´æ¯”è³½ã€‚`;
            } else if (gameOver) {
                // æœ¬å±€çµæŸï¼Œé€²è¡Œå±€é–“é‡ç½® (ä¸‹ä¸€å±€)
                if (showMessage) {
                    gameMessage.textContent = `ğŸ‰ é–‹å§‹ä¸‹ä¸€å±€ï¼`;
                }
            }
            
            scores = [0, 0];
            // serverIndex å·²ç¶“åœ¨ä¸Šæ–¹é‡ç½®
            gameOver = false;
            history = []; // é‡ç½®æ™‚æ¸…é™¤æ­·å²è¨˜éŒ„

            // é‡æ–°å•Ÿç”¨æŒ‰éˆ•ï¼Œé™¤éæ¯”è³½é‚„æ²’çµæŸ
            if (!matchOver) {
                pointButtons.forEach(btn => btn.disabled = false);
            }
            
            // å¦‚æœæ˜¯é¦–æ¬¡è¼‰å…¥ï¼Œæˆ–è€… setGameMode å‘¼å«ï¼Œä¸é¡¯ç¤ºè¨Šæ¯
            if (showMessage && !matchOver && !gameOver) {
                 gameMessage.textContent = `ğŸ‰ æ–°çš„ä¸€å±€é–‹å§‹äº†ï¼`;
            } else if (!showMessage && !matchOver) {
                gameMessage.textContent = '';
            }
            
            render();
        }

        // é¦–æ¬¡è¼‰å…¥æ™‚ï¼šè¨­å®šé è¨­æ¨¡å¼ï¼ˆå–®æ‰“ï¼‰å’Œä¸‰å±€å…©å‹åˆ¶ä¸¦åˆå§‹åŒ–éŠæˆ²
        window.onload = () => {
            // 1. è¨­ç½®éŠæˆ²æ¨¡å¼ç‚ºå–®æ‰“ (SINGLES)
            setGameMode(MODE_SINGLES);
            // 2. è¨­ç½®å±€æ•¸æ ¼å¼ç‚ºä¸‰å±€å…©å‹ (3)
            setMatchFormat(3); 
        };

    </script>

</body>
</html>